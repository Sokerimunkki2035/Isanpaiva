<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kahvipöytä – Ääniystävä</title>
<style>
  body{background:#fafafa;font-family:system-ui,Arial;margin:0}
  header{position:sticky;top:0;background:#fff;padding:14px 16px;
    box-shadow:0 1px 6px rgba(0,0,0,.06)}
  h1{font-size:20px;margin:0}
  main{padding:16px}
  .chat{background:#fff;border:1px solid #eee;border-radius:14px;
    padding:12px;max-height:60vh;overflow:auto}
  .msg{margin:10px 0}
  .me{color:#111}
  .hanhi{color:#0d6efd}
  .pappa{color:#16a34a}
  .row{display:flex;gap:8px;margin-top:10px}
  .row button{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;background:#fff}
  .input{display:flex;gap:8px;margin-top:10px}
  .input input{flex:1;padding:12px;border:1px solid #ddd;border-radius:10px}
  .input button{padding:12px 14px;border:1px solid #ddd;border-radius:10px;background:#fff}
  .small{font-size:12px;color:#666;margin-top:6px}
</style>
</head>
<body>
<header><h1>☕ Kahvipöytä – Ääniystävä</h1></header>
<main>
  <div id="chat" class="chat" aria-live="polite"></div>

  <div class="row">
    <button onclick="preset('minulla ei ole ketään')">minulla ei ole ketään</button>
    <button onclick="preset('oli hyvä päivä töissä')">oli hyvä päivä töissä</button>
    <button onclick="preset('saanko kysyä jotain')">saanko kysyä jotain</button>
  </div>

  <div class="input">
    <input id="text" placeholder="Kirjoita tähän ja paina Lähetä…">
    <button onclick="send()">Lähetä</button>
    <button onclick="stopSpeak()">⏹</button>
  </div>
  <div class="small">Vinkki: Ääni toistuu vain käyttäjän klikkauksen jälkeen (selaimen sääntö).</div>
</main>

<script>
/* --- perus TTS --- */
const synth = window.speechSynthesis;
function say(text, lang = "fi-FI"){
  try{synth.cancel();}catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  synth.speak(u);
}
function stopSpeak(){ try{synth.cancel();}catch(e){} }

/* odota että puhe loppuu  */
function awaitSpeechEnd(){
  return new Promise(resolve=>{
    const id=setInterval(()=>{
      if(!synth.speaking && !synth.pending){
        clearInterval(id); resolve();
      }
    },200);
  });
}

/* --- UI helperit --- */
const chat = document.getElementById('chat');
function addLine(cls, who, text){
  const div = document.createElement('div');
  div.className = 'msg ' + cls;
  div.textContent = who + ': ' + text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* --- kevyt moderointi --- */
const banned=[/rasis/i,/neger/i,/hitler/i,/natsi/i];
function isBad(t){ return banned.some(rx=>rx.test(t)); }

/* --- persona fragmentit --- */
function pick(arr){return arr[Math.floor(Math.random()*arr.length)];}

function hanhiReply(){
  const starts=["Olen tässä vierelläsi, kuulolla.","Kuulen sinut ja haluan, että tunnet olosi turvalliseksi."];
  const middles=["Olen kulkenut monien maiden yli ja oppinut, että lempeys kantaa.","Et ole yksin, vaikka siltä saattaa tuntua."];
  const ends=["Haluatko kertoa lisää, honk?","Jatketaan yhdessä vielä hetki, honk."];
  return pick(starts)+" "+pick(middles)+" "+pick(ends);
}

function pappaReply(){
  const starts=["Istun tähän viereen, kaadan kuppiin vielä tilkan, ihaa.","Matkoilla opin: askel kerrallaan riittää, ihaa."];
  const questions=["Mihin suuntaan sydän kallistuisi seuraavaksi?","Mikä olisi sinulle pieni hyvä juttu tänään?"];
  return pick(starts)+" "+pick(questions);
}

/* --- lähetyslogiikka --- */
function preset(text){document.getElementById('text').value=text;send();}

async function send(){
  const inp=document.getElementById('text');
  const user=(inp.value||"").trim();
  if(!user)return;

  addLine('me','Sinä',user);

  if(isBad(user)){
    const safe="Pidetään keskustelu turvallisena ja kunnioittavana.";
    addLine('hanhi','Äiti-Hanhi',safe+" honk.");
    say(safe+" honk.");
    await awaitSpeechEnd();
    const follow="Voimme puhua tunteista ja elämästä, ihaa. Mikä painaa juuri nyt?";
    addLine('pappa','Aasi-pappa',follow);
    say(follow);
    inp.value="";return;
  }

  const h=hanhiReply(user);
  addLine('hanhi','Äiti-Hanhi',h);
  say(h);
  await awaitSpeechEnd(); // <-- odota hanhi loppuun asti

  const p=pappaReply(user);
  addLine('pappa','Aasi-pappa',p);
  say(p);

  inp.value="";
}
</script>
</body>
</html>